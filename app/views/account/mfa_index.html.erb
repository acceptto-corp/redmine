<%= javascript_include_tag "#{Rails.application.config.faye_server}/faye.js", "data-turbolinks-track" => false %>
<script type="text/javascript">
    $(function() {
        var faye = new Faye.Client("<%= Rails.application.config.faye_server %>");
        faye.subscribe("/messages/<%= @channel %>", function(data) {
            window.location.replace("/account/mfa_check?channel=<%= @channel %>");
        });

        var now = new Date();

        var target_date = new Date(now.getTime() + 60000);

        // variables for time units
        var days, hours, minutes, seconds;

        // get tag element
        var countdown = document.getElementById("flash_notice");
        var notice_text = countdown.innerHTML

        // update the tag with id "countdown" every 1 second
        setInterval(function () {

            // find the amount of "seconds" between now and target
            var current_date = new Date().getTime();
            var seconds_left = (target_date - current_date) / 1000;

            // do some time calculations
            days = parseInt(seconds_left / 86400);
            seconds_left = seconds_left % 86400;

            hours = parseInt(seconds_left / 3600);
            seconds_left = seconds_left % 3600;

            minutes = parseInt(seconds_left / 60);
            seconds = parseInt(seconds_left % 60);

            if (seconds == 0) {
                window.location.replace("/account/mfa_check?channel=<%= @channel %>");
            }

            if (seconds <= 0) {
                seconds = 0;
            }

            // format countdown string + set tag value
            countdown.innerHTML = notice_text + " : " + days + "d, " + hours + "h, "
                    + minutes + "m, " + seconds + "s";

        }, 1000);

    });
</script>